<div class="map-container">
  <div id="map"></div>

  <div class="map-legend">
    {% for pin in page.pins %}
      <span class="map-legend__item">
        <img src="{{ pin.last }}" class="map-legend__icon" alt="Pin"> {{ pin.first }}
      </span>
    {% endfor %}
  </div>

  <button class="close-map js-toggle-map ss-navigateup" tabindex="-1">Hide map</button>
</div>

<script src="//maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
<script>
//todo: move this to external file

var mapCenter = new google.maps.LatLng(40.74,-73.98);
var map = new google.maps.Map(document.getElementById('map'), {
  zoom: 12,
  scrollwheel: false,
  disableDefaultUI: true,
  zoomControl: true,
  panControl: true,
  center: mapCenter
});

function centerMap() {
  google.maps.event.trigger(map, 'resize');
  map.setCenter(mapCenter);
}

function initializeMap() {
  var infowindows = [];
  var bounds = new google.maps.LatLngBounds();
  var geocoder = new google.maps.Geocoder();

  {% for item in site.locations %}

  {% capture item_content %}
    {% include card.html item=location %}
    <p><a href="{{ item.url }}" class="more">View details</a></p>
  {% endcapture %}
  //todo: use coordinates when provided
  geocoder.geocode({'address': {{ item.address | strip_newlines | jsonify }} }, function(results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      var marker = new google.maps.Marker({
        map: map,
        position: results[0].geometry.location,
        title: {{ item.title | jsonify }},
        icon: {{ page.pins[item.type] | jsonify }}
      });
      //bounds.extend(marker.getPosition());
      //map.fitBounds(bounds);
      var infowindow{{item.slug | replace:'-',''}} = new google.maps.InfoWindow({
        content: {{ item_content | strip_newlines | jsonify }}
      });
      google.maps.event.addListener(marker, 'click', function() {
        for (var i=0;i<infowindows.length;i++) {
          infowindows[i].close();
        }
        infowindow{{item.slug | replace:'-',''}}.open(map,marker);
      });
      infowindows.push(infowindow{{item.slug | replace:'-',''}});
    }
  });
  {% endfor %}

}
google.maps.event.addDomListener(window, 'load', initializeMap);
</script>